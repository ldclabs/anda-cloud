name: Release
on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v1.0.0)"
        required: true
        type: string
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: Swatinem/rust-cache@v2
      - name: Build canisters
        run: |
          mkdir -p out
          rustup update --no-self-update stable
          rustup target add wasm32-unknown-unknown
          cargo install ic-wasm
          cargo build --target wasm32-unknown-unknown --release --locked -p anda_registry_canister -p anda_x402_canister
          for CAN in anda_registry_canister anda_x402_canister
          do
            cp "target/wasm32-unknown-unknown/release/$CAN.wasm" out/
            cp "src/$CAN/$CAN.did" "out/$CAN.did"
            WASM="out/$CAN.wasm"
            ic-wasm $WASM -o $WASM metadata candid:service -f "out/$CAN.did" -v public
            ic-wasm $WASM -o $WASM shrink
            ic-wasm $WASM -o $WASM optimize O3 --inline-functions-with-loops
            gzip $WASM
            SHA256="$(sha256sum < "out/$CAN.wasm.gz" | sed 's/ .*$//g')"
            echo $SHA256 > "out/$CAN.wasm.gz.$SHA256.txt"
          done
          ls -lah out
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: out/*
